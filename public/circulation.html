<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>スマート貸出・返却 | LibraryCirculationSystem</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDKs (必要最小限) -->
    <script defer src="/__/firebase/12.4.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.4.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/12.4.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    <script defer src="firebase-config.js"></script>
    <script defer src="firebase-init.js"></script>

    <!-- html5-qrcode（ユーザー提案の簡易URL） -->
    <script defer src="https://unpkg.com/html5-qrcode"></script>

    <script defer src="guard.js"></script>
    <script defer src="circulation.js"></script>
    <script defer src="barcode-scanner.js"></script>
  </head>
  <body>
    <!-- デスクトップ用ヘッダーナビ -->
    <header class="header-nav">
      <div class="nav-container">
        <div class="nav-brand">
          <h1>📚 Library System</h1>
        </div>
        <nav class="nav-menu">
          <a href="index.html" class="nav-link">
            <span class="nav-icon">🔍</span>
            <span class="nav-text">検索</span>
          </a>
          <a href="circulation.html" class="nav-link active">
            <span class="nav-icon">📱</span>
            <span class="nav-text">貸出・返却</span>
          </a>
          <a href="mypage.html" class="nav-link">
            <span class="nav-icon">👤</span>
            <span class="nav-text">マイページ</span>
          </a>
          <a href="admin.html" class="nav-link">
            <span class="nav-icon">⚙️</span>
            <span class="nav-text">管理</span>
          </a>
        </nav>
        <div class="nav-actions">
          <button class="logout-btn" onclick="signOut()">ログアウト</button>
        </div>
      </div>
    </header>

    <!-- モバイル用ボトムナビ -->
    <nav class="bottom-nav">
      <a href="index.html" class="bottom-nav-item">
        <span class="bottom-nav-icon">🔍</span>
        <span class="bottom-nav-text">検索</span>
      </a>
      <a href="circulation.html" class="bottom-nav-item active">
        <span class="bottom-nav-icon">📱</span>
        <span class="bottom-nav-text">貸出・返却</span>
      </a>
      <a href="mypage.html" class="bottom-nav-item">
        <span class="bottom-nav-icon">👤</span>
        <span class="bottom-nav-text">マイページ</span>
      </a>
      <a href="admin.html" class="bottom-nav-item">
        <span class="bottom-nav-icon">⚙️</span>
        <span class="bottom-nav-text">管理</span>
      </a>
    </nav>

    <main class="container">
      <h1>📱 スマート貸出・返却システム</h1>
      <p class="muted">本の背表紙をスキャンするだけで、自動的に登録・貸出・返却を行います</p>

      <!-- OCRカメラスキャナー -->
      <div class="section">
        <h2>📷 本をスキャン</h2>
        <div class="scanner-container">
          <video id="cameraPreview" class="camera-video" style="display: none;"></video>
          <canvas id="captureCanvas" style="display: none;"></canvas>
          
          <div class="camera-controls">
            <button id="startCameraBtn" onclick="startCamera()">カメラ開始</button>
            <button id="captureBtn" onclick="captureAndScan()" style="display: none;">スキャン実行</button>
            <button id="stopCameraBtn" onclick="stopCamera()" style="display: none;">カメラ停止</button>
          </div>
          
          <div id="ocrProgress" class="hint"></div>
          <div id="ocrResult" class="hint"></div>
        </div>
      </div>

      <!-- スキャン結果表示 -->
      <div class="section" id="scanResultSection" style="display: none;">
        <h2>📄 スキャン結果</h2>
        <div class="result-card">
          <h3>認識されたテキスト:</h3>
          <div id="rawOcrText" class="debug-text">認識されたテキストがここに表示されます...</div>
          
          <h3>検出された識別子:</h3>
          <div id="identifierSelection">識別子の検出を待機中...</div>
        </div>
      </div>

      <!-- 処理結果表示 -->
      <div class="section" id="actionResultSection" style="display: none;">
        <h2>🔄 処理結果</h2>
        <div id="actionResult" class="result-card"></div>
      </div>

      <!-- 手動入力（緊急時用） -->
      <div class="section" style="border-top: 2px solid #eee; padding-top: 20px;">
        <details>
          <summary style="cursor: pointer; color: var(--muted);">手動入力（緊急時用）</summary>
          <div style="margin-top: 15px;">
            <div class="form-row">
              <input id="manualBookId" type="text" placeholder="蔵書ID" aria-label="蔵書ID">
              <input id="manualTitle" type="text" placeholder="書名（新規登録時のみ）" aria-label="書名">
              <button onclick="processManualInput()">処理実行</button>
            </div>
            <div id="manualResult" class="hint"></div>
          </div>
        </details>
      </div>
    </main>
  </body>
</html>